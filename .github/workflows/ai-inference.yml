name: 'ai-inference Auto Summarize'

on:
  workflow_dispatch:
  push:
    paths:
      - 'AI_inputs/*.md'

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest input file
        run: |
          INPUT_FILE=$(ls -t AI_inputs/*.md | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "AI_inputsにファイルがありません"
            exit 1
          fi
          echo "INPUT_FILE=$INPUT_FILE" >> $GITHUB_ENV
          DATE=$(TZ=Asia/Tokyo date +"%Y-%m%d-%H%M")
          ORIGINAL_NAME=$(basename "$INPUT_FILE" .md)
          echo "FILE_NAME=AI_output/${DATE}_${ORIGINAL_NAME}.txt" >> $GITHUB_ENV

      - name: Select summarize prompt
        id: summarize_prompt
        run: |
          echo "file=.github/personas/summarize.txt" >> $GITHUB_OUTPUT

      - name: AI inference - summarize
        id: inference_summarize
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          max-tokens: 3000
          prompt-file: ${{ env.INPUT_FILE }}
          system-prompt-file: ${{ steps.summarize_prompt.outputs.file }}

      - name: Save AI response to file
        run: |
          mkdir -p AI_output
          echo "${{ steps.inference_summarize.outputs.response }}" > "${FILE_NAME}"
          echo "生成完了: ${FILE_NAME}"

      - name: Delete original input file
        run: |
          if [ -f "$INPUT_FILE" ]; then
            rm "$INPUT_FILE"
            echo "元ファイルを削除しました: $INPUT_FILE"
          else
            echo "削除対象のファイルが存在しません: $INPUT_FILE"
          fi

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Add AI summary and delete input ${{ github.run_id }}
          all: true
          file_pattern: |
            AI_output/*.txt
            AI_inputs/