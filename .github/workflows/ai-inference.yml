name: 'ai-inference Auto Summarize'

on:
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 実行日付ファイル名を作成（例: 2026-0220-2134.txt）
      - name: Set date filename
        run: |
          DATE=$(TZ=Asia/Tokyo date +"%Y-%m%d-%H%M")
          echo "FILE_NAME=AI_output/${DATE}.txt" >> $GITHUB_ENV

      # プロンプト選択
      - name: Select random persona
        id: persona
        run: |
          personas=(.github/personas/*.txt)
          echo "Found ${#personas[@]} persona files:"
          printf '%s\n' "${personas[@]}"
          selected=${personas[$RANDOM % ${#personas[@]}]}
          echo "Selected: $selected"
          echo "file=$selected" >> $GITHUB_OUTPUT

      # AI推論
      - name: AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          max-tokens: 2500
          prompt-file: AI_inputs/a.md
          system-prompt-file: ${{ steps.persona.outputs.file }}
          # system-prompt: |

      # 出力をファイルに保存
      - name: Save AI response
        run: |
          echo "${{ steps.inference.outputs.response }}" > "${{ env.FILE_NAME }}"

      # 自動コミット
      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Add AI summary ${{ github.run_id }}
          file_pattern: AI_output/*.md