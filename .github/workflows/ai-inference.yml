name: 'ai-inference Auto Summarize'

on:
  workflow_dispatch:
  push:
    paths:
      - 'AI_inputs/*.md'

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest input file
        run: |
          INPUT_FILE=$(ls -t AI_inputs/*.md | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "AI_inputsにファイルがありません"
            exit 1
          fi
          echo "INPUT_FILE=$INPUT_FILE" >> $GITHUB_ENV
          DATE=$(TZ=Asia/Tokyo date +"%Y-%m%d-%H%M")
          ORIGINAL_NAME=$(basename "$INPUT_FILE" .md)
          echo "FILE_NAME=AI_output/${DATE}_${ORIGINAL_NAME}.txt" >> $GITHUB_ENV

      - name: Select summarize prompt
        id: summarize_prompt
        run: |
          echo "file=.github/personas/summarize.txt" >> $GITHUB_OUTPUT

      - name: AI inference - summarize
        id: inference_summarize
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          max-tokens: 3000
          prompt-file: ${{ env.INPUT_FILE }}
          system-prompt-file: ${{ steps.summarize_prompt.outputs.file }}

      - name: Save response and move input if success
        run: |
          set -e
          mkdir -p AI_output
          mkdir -p AI_archived

          # ヒアドキュメントで安全にMarkdownを保存
          cat <<'EOF' > "${FILE_NAME}"
          ${{ steps.inference_summarize.outputs.response }}
          EOF

          # 正常性チェック
          if [ ! -s "${FILE_NAME}" ]; then
            echo "生成失敗。移動しません。"
            exit 1
          fi

          # 元ファイルをアーカイブに移動（スペース入り対応）
          if [ -f "${INPUT_FILE}" ]; then
            mv "${INPUT_FILE}" AI_archived/
            echo "元ファイルを AI_archived に移動しました: ${INPUT_FILE}"
          else
            echo "移動対象のファイルが存在しません: ${INPUT_FILE}"
            exit 1
          fi

          # 確認用
          echo "AI_archived の内容:"
          ls -l AI_archived/
          echo "AI_inputs の内容:"
          ls -l AI_inputs/

          echo "正常保存＆移動完了"

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Add AI summary ${{ github.run_id }}
          file_pattern: AI_output/*.txt