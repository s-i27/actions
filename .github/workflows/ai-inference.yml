name: 'ai-inference Auto Summarize'

on:
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 実行日付ファイル名
      - name: Set date filename
        run: |
          DATE=$(TZ=Asia/Tokyo date +"%Y-%m%d-%H%M")
          echo "FILE_NAME=AI_output/${DATE}.txt" >> $GITHUB_ENV

      # Persona選択
      - name: Select random persona
        id: persona
        run: |
          personas=(.github/personas/*.txt)
          selected=${personas[$RANDOM % ${#personas[@]}]}
          echo "file=$selected" >> $GITHUB_OUTPUT

      # AI推論
      - name: AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          max-tokens: 2500
          prompt-file: AI_inputs/a.md
          system-prompt-file: ${{ steps.persona.outputs.file }}

      # 保存（FILE_NAMEに修正）
      - name: Save AI response
        run: |
          mkdir -p AI_output
          echo "${{ steps.inference.outputs.response }}" > "${{ env.FILE_NAME }}"

      # 空ファイル防止
      - name: Validate file
        run: |
          if [ ! -s "${{ env.FILE_NAME }}" ]; then
            echo "生成失敗"
            exit 1
          fi

      # 自動コミット
      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Add AI summary ${{ github.run_id }}
          file_pattern: AI_output/*.txt