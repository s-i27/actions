name: 'ai-inference Auto Summarize'

on:
  workflow_dispatch:

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 最新のAI_inputs内ファイルを取得
      - name: Get latest input file
        run: |
          INPUT_FILE=$(ls -t AI_inputs/*.md | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "AI_inputsにファイルがありません"
            exit 1
          fi
          echo "INPUT_FILE=$INPUT_FILE" >> $GITHUB_ENV

          DATE=$(TZ=Asia/Tokyo date +"%Y-%m%d-%H%M")
          ORIGINAL_NAME=$(basename "$INPUT_FILE" .md)
          echo "FILE_NAME=AI_output/${DATE}_${ORIGINAL_NAME}.txt" >> $GITHUB_ENV

      # プロンプト選択
      - name: Select random persona
        id: persona
        run: |
          personas=(.github/personas/*.txt)
          selected=${personas[$RANDOM % ${#personas[@]}]}
          echo "file=$selected" >> $GITHUB_OUTPUT

      # AI推論
      - name: AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          max-tokens: 2500
          prompt-file: ${{ env.INPUT_FILE }}
          system-prompt-file: ${{ steps.persona.outputs.file }}

      # 保存
      - name: Save AI response
        run: |
          mkdir -p AI_output
          echo "${{ steps.inference.outputs.response }}" > "${{ env.FILE_NAME }}"

      # 自動コミット
      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Add AI summary ${{ github.run_id }}
          file_pattern: AI_output/*.txt