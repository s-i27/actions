name: 'ai-inference Auto Summarize'

on:
  workflow_dispatch:
  push:
    paths:
      - 'AI_inputs/*.md'

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      models: read

    steps:
      - uses: actions/checkout@v4

      # 最新のAI_inputs内ファイルを取得
      - name: Get latest input file
        run: |
          INPUT_FILE=$(ls -t AI_inputs/*.md | head -n 1)
          if [ -z "$INPUT_FILE" ]; then
            echo "AI_inputsにファイルがありません"
            exit 1
          fi
          echo "INPUT_FILE=$INPUT_FILE" >> $GITHUB_ENV

          DATE=$(TZ=Asia/Tokyo date +"%Y-%m%d-%H%M")
          BASE_NAME=$(basename "$INPUT_FILE" .md)
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "BASE_NAME=$BASE_NAME" >> $GITHUB_ENV

          # 共通単語リストファイル（MAINファイル）
          echo "VOCAB_FILE=2.単語_AWS_ジャンル/AWS_ALL.md" >> $GITHUB_ENV

          # 要約ファイル
          echo "SUMMARY_FILE=AI_output/${DATE}_${BASE_NAME}.txt" >> $GITHUB_ENV

      - name: Prepare directories
        run: |
          mkdir -p AI_output
          mkdir -p 2.単語_AWS_ジャンル
          mkdir -p AI_archived

      - name: Select vocab prompt
        id: vocab_prompt
        run: echo "file=.github/personas/generate_vocab.txt" >> $GITHUB_OUTPUT

      - name: AI inference - vocab
        id: inference_vocab
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          max-tokens: 2000
          prompt-file: ${{ env.INPUT_FILE }}
          system-prompt-file: ${{ steps.vocab_prompt.outputs.file }}

      - name: Select summarize prompt
        id: summarize_prompt
        run: echo "file=.github/personas/summarize.txt" >> $GITHUB_OUTPUT

      - name: AI inference - summarize
        id: inference_summarize
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          max-tokens: 2500
          prompt-file: ${{ env.INPUT_FILE }}
          system-prompt-file: ${{ steps.summarize_prompt.outputs.file }}

      - name: Save responses and move input if success
        run: |
          # 要約ファイルを作成
          printf "%s\n" "${{ steps.inference_summarize.outputs.response }}" > "${{ env.SUMMARY_FILE }}"

          # 単語リストは共通MAINファイルに追記
          printf "\n%s\n" "${{ steps.inference_vocab.outputs.response }}" >> "${{ env.VOCAB_FILE }}"

          if [ ! -s "${{ env.SUMMARY_FILE }}" ]; then
            echo "生成失敗。移動しません。"
            exit 1
          fi

          # 元ファイルをアーカイブに移動
          mv "$INPUT_FILE" AI_archived/
          echo "正常保存＆移動完了"

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Add AI summary ${{ github.run_id }}
          file_pattern: |
            AI_output/*.txt
            2.単語_AWS_ジャンル/AWS_ALL.md