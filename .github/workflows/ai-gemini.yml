name: 'Gemini Auto Summarize'

on:
  workflow_dispatch:

jobs:
  summarize-note:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set date filename
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "TODAY_FILE=AI_output/${DATE}.txt" >> $GITHUB_ENV

      - name: Run Gemini CLI with GitHub MCP
        uses: google-github-actions/run-gemini-cli@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-flash
          workflow_name: summarize-note
          settings: |
            {
              "model": { "maxSessionTurns": 2 },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "-e",
                    "GITHUB_REPOSITORY",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "includeTools": [
                    "get_file_contents",
                    "create_or_update_file"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}",
                    "GITHUB_REPOSITORY": "${{ github.repository }}"
                  }
                }
              }
            }
          prompt: |
            あなたは通常テキストを出力してはいけません。
            必ずツール呼び出しのみを実行してください。

            手順:

            1. get_file_contents を使って
               AI_inputs/a.md を読み込む。

            2. 内容を要約する。

            3. create_or_update_file を以下のJSONで実行する。

            {
              "path": "${{ env.TODAY_FILE }}",
              "branch": "main",
              "content": "<要約全文>",
              "commit_message": "Update summary from Gemini CLI"
            }

            説明文は禁止。
            必ずツール呼び出しのみ実行すること。
